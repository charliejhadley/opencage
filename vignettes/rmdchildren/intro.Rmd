# Geocoding

The [OpenCage](https://opencagedata.com/) API supports forward and reverse geocoding. Sources of OpenCage are open geospatial data including OpenStreetMap, Yahoo! GeoPlanet, Natural Earth Data, Thematic Mapping, Ordnance Survey OpenSpace, Statistics New Zealand, Zillow, MaxMind, GeoNames, the US Census Bureau and Flickr's shapefiles plus a whole lot more besides. See [this page](https://opencagedata.com/credits) for the full list of credits.

## API key

To use the package, you will need to register at https://opencagedata.com/users/sign_up to get an API key. The "Free Trial" plan provides up to 2,500 API requests a day. 

The geocoding functions of the package will conveniently retrieve your API key with `oc_key()` if it is saved in the environment variable `"OPENCAGE_KEY"`. For ease of use, save your API key as an environment variable in `.Renviron` as described at http://happygitwithr.com/api-tokens.html.

## Forward geocoding

Forward geocoding is from placename to latitude and longitude tuple(s).

```{r, warning = FALSE, message = FALSE}
library("opencage")
output <- oc_forward(placename = "Sarzeau")
knitr::kable(output)
```

## Reverse geocoding

Reverse geocoding is from latitude and longitude to placename(s).

```{r, message=FALSE}
output2 <- oc_reverse(latitude = 51.5034070, longitude = -0.1275920)
knitr::kable(output2)
```

Note that all coordinates sent to the OpenCage API must adhere to the [WGS 84](https://en.wikipedia.org/wiki/World_Geodetic_System) ([EPSG:4326](http://epsg.io/4326)) [coordinate reference system](https://en.wikipedia.org/wiki/Spatial_reference_system) in decimal format. There is usually no reason to send more than six or seven digits past the decimal as that then gets down to the [precision of a centimetre](https://en.wikipedia.org/wiki/Decimal_degrees).

## Return type

Depending on what you specify as the `return` parameter, `oc_forward()` and `oc_reverse()` will return either a list of tibbles (`df_list`, the default), JSON lists (`json_list`), GeoJSON lists (`geojson_list`), or the URL with which the API would be called (`url_only`).

Both `oc_forward_df()` and `oc_reverse_df()` return a single tibble. 

## Multiple results

Forward geocoding typically returns multiple results. Regarding these ambiguous results, the API doc [states](https://opencagedata.com/api#ambiguous-results): "When forward geocoding we may find multiple valid matches. Many places have the same or similar names. In this case the geocoder will return multiple results. The `confidence`, coordinates, or [`type` fields] for each result should be examined to determine whether each result from an ambiguous query is sufficiently correct to warrant using a result or not. A good strategy to reduce ambiguity is to use the optional `bounds`, `countrycode`, and/or `proximity`. parameters." Multiple results might mean you get a result for an airport and a road when querying a city name, or results for cities with the same name in different countries. 

When building queries, OpenCage [best practices docs](https://opencagedata.com/api#bestpractices) can be very useful.

## Specifying the target area

The `bounds`, `countrycode` and `proximity` arguments can make the query more precise. They are only relevant and available for forward geocoding. 

* `bounds`: Provides the geocoder with a hint to the region that the query resides in. This value will restrict the possible results to the supplied region. The bounds parameter can most easily be specified with `oc_bbox()`as 4 coordinate points forming the south-west and north-east corners of a bounding box, i.e. `(xmin, ymin, xmax, ymax)`. For example, it can be specified as `bounds = oc_bbox(-0.56, 51.28, 0.27, 51.68)`.

Below is an example of the use of `bounds` where the rectangle given in the second call does not include Europe so that we don't get results for Berlin in Germany.

```{r, message=FALSE}
results1 <- oc_forward(placename = "Berlin")
knitr::kable(results1)
results2 <- oc_forward(placename = "Berlin", bounds = oc_bbox(-90,38,0, 45))
knitr::kable(results2)
```

* `countrycode`: The `countrycode` parameter restricts the results to the given country. The country code is a two letter code as defined by the [ISO 3166-1 Alpha 2](https://www.iso.org/obp/ui/#search/code) standard. E.g. "GB" for the United Kingdom, "FR" for France, "US" for United States. Multiple countrycodes per `placename` must be wrapped in a list. See example below.

```{r, message=FALSE}
results3 <- oc_forward(placename = "Berlin", countrycode = "DE")
knitr::kable(results3)

results4 <- oc_forward(placename = c("Paris"), countrycode = list(c("FR", "US")))
knitr::kable(results4)

```

## Specifying what is returned

* `language`: If you would like to get your results in a specific language, you can pass an [IETF language tag](https://en.wikipedia.org/wiki/IETF_language_tag), such as "es" for Spanish or "pt-BR" for Brazilian Portuguese, to the `language` parameter. OpenCage will attempt to return results in that language. If it is not specified, "en" (English) will be assumed by the API.

```{r, message=FALSE}
results5 <- oc_forward(placename = "Berlin", country = "DE", language = "de")
knitr::kable(results5)

```

* `limit` specifies the maximum number of results that should be returned. Integer values between 1 and 100 are allowed, the default is 10 for `oc_forward()` and 1 for `oc_forward_df()`. Reverse geocoding always returns at most one result. 

* `min_confidence`, an integer value between 0 and 10, indicates the precision of the returned result as defined by it's geographical extent, (i.e. by the extent of the result's bounding box). See the \href{API documentation}{https://opencagedata.com/api#confidence} for details. Only results with at least the requested confidence will be returned.

* `no_annotations`: OpenCage supplies additional information about the result location in the annotations field. The annotations include, among others, country information, time of sunset and sunrise, or the location in different geocoding formats, like Maidenhead, Mercator projection (EPSG 3857), geohash or what3words. Some annotations, like the Irish Transverse Mercator (ITM) or the US Federal Information Processing Standards (FIPS) code will only be shown, where appropriate. `no_annotations` is `TRUE` by default, which means that the output will not contain annotations.

* `no_dedupe` is `FALSE` by default. When TRUE the output will not be deduplicated.

 For more information about the output and the query parameters, see the package documentation, the [API doc](https://opencagedata.com/api) and [OpenCage FAQ](https://opencagedata.com/faq).

## Caching

The underlying data at OpenCage is updated about once a day. Note that this package uses [memoise](https://github.com/r-lib/memoise) with no timeout argument so that results are cached inside an active R session. 

```{r, message=FALSE}
system.time(oc_reverse(latitude = 10, longitude = 10))

system.time(oc_reverse(latitude = 10, longitude = 10))

```

To clear the cache of all results, you need to call `memoise::forget(opencage:::oc_get_memoise)`.

```{r, message=FALSE}
memoise::forget(opencage:::oc_get_memoise)
system.time(oc_reverse(latitude = 10, longitude = 10))

```

## Privacy

All geocoding functions have a parameter `no_record`. It is `FALSE` by default. 

* When `no_record` is `FALSE` a log of the query is made by OpenCage. These logs are used for debugging and in order to improve the service. [According](https://opencagedata.com/faq#legal) to OpenCage, all logs are automatically deleted after six months. 

* When `no_record` is `TRUE`, OpenCage still records that a request was made (e.g. to see whether you exceeded your quota), but not the specific content of your query. Please use if you have concerns about privacy and want OpenCage to have no record of your query. More information about privacy can be found on OpenCage's [GDPR page](https://opencagedata.com/gdpr).

## Addresses

The geocoding functions also have an `abbr` parameter, `FALSE` by default. When it is `TRUE` the addresses in the `formatted` field of the results are abbreviated (e.g. "Main St." instead of "Main Street"). For more details see [this blog post](http://blog.opencagedata.com/post/160294347883/shrtr-pls).

## Return query text

`oc_forward()` and `oc_reverse()` have an `add_request` argument, indicating whether the request is returned again with the results. If the `return` value is a `df_list`, the `placename` or `latitude,longitude` is added as a column to the results. `json_list` results will contain all request parameters, including the API key used! For `geojson_list` results `add_request` is currently ignored by OpenCage.
