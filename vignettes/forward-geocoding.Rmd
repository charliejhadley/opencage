---
title: "Forward geocoding: Converting addresses to coordinates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{forward-geocoding_addresses-to-coordinates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(opencage)
```

```{r forward, warning = FALSE, message = FALSE}
library("opencage")
output <- oc_forward(placename = "Sarzeau")
knitr::kable(output)
```

## Multiple results

Forward geocoding typically returns multiple results. Regarding these ambiguous results, the [OpenCage API doc](https://opencagedata.com/api#ambiguous-results) states: "When forward geocoding we may find multiple valid matches. Many places have the same or similar names. In this case we return multiple results [[ranked by relevance](https://opencagedata.com/api#ranking)]. The `confidence`, coordinates, or [`type` fields] for each result should be examined to determine whether each result from an ambiguous query is sufficiently correct to warrant using a result or not. A good strategy to reduce ambiguity is to use the optional `bounds`, `countrycode`, and/or `proximity` parameters." Multiple results might mean you get a result for an airport and a road when querying a city name, or results for cities with the same name in different countries. 

When building queries, OpenCage's [best practices](https://opencagedata.com/api#bestpractices) can be very useful.

## Specifying what is returned

* `language`: If you would like to get your results in a specific language, you can pass an [IETF BCP 47 language tag](https://en.wikipedia.org/wiki/IETF_language_tag), such as "es" for Spanish or "pt-BR" for Brazilian Portuguese, to the `language` parameter. OpenCage will attempt to return results in that language. Alternatively you can specify the "native" tag, in which case OpenCage will attempt to return the response in the "official" language(s). For further details see [OpenCage's API documentation](https://opencagedata.com/api#language) on that subject. In case the `language` parameter is set to `NULL` (which is the default), the tag is not recognized, or OpenCage does not have a record in that language, the results will be returned in English. 

  To find the correct language tag for your desired language, you can search for the language on the [BCP47 language subtag lookup](https://r12a.github.io/app-subtags/) for example. Note however, that there are some language tags in use on e.g. OpenStreetMap, one of OpenCage's main sources, that do not conform with the IETF BCP 47 standard. For example OSM uses [`zh_pinyin`](https://wiki.openstreetmap.org/w/index.php?title=Multilingual_names#China) instead of `zh-Latn-pinyin` for [Hanyu Pinyin](https://en.wikipedia.org/wiki/Pinyin). It might therefore be helpful to consult the details page of e.g. the target country on openstreetmap.org in order to see which language tags are actually used. In any case, neither OpenCage nor the functions in this package will validate the language tags you provide.

```{r language, message=FALSE}
results6 <- oc_forward(placename = "Berlin", country = "DE", language = "de")
knitr::kable(results6)

```

* `limit` specifies the maximum number of results that should be returned. Integer values between 1 and 100 are allowed, the default is 10 for `oc_forward()` and 1 for `oc_forward_df()`. Reverse geocoding always returns at most one result. 

* `min_confidence`, an integer value between 0 and 10, indicates the precision of the returned result as defined by its geographical extent, (i.e. by the extent of the result's bounding box). See the \href{API documentation}{https://opencagedata.com/api#confidence} for details. Only results with at least the requested confidence will be returned.

* `roadinfo`, a logical vector, indicates whether the geocoder should attempt to match the nearest road (rather than an address) and provide additional road and driving information. It is `FALSE` by default, which means OpenCage will not attempt to match the nearest road. Some road and driving information is nevertheless provided as part of the annotations (see below), if `roadinfo` is set to `FALSE`. 

```{r roadinfo, message=FALSE}
results7 <- oc_forward(placename = "Europa Advance Rd", roadinfo = TRUE)
knitr::kable(results7)

```

* `no_annotations`: OpenCage supplies additional information about the result location in the [annotations](https://opencagedata.com/api#annotations). They include, among others, country information, time of sunset and sunrise, or the location in different geocoding formats, like Maidenhead, Mercator projection (EPSG 3857), geohash or what3words. Some annotations, like the Irish Transverse Mercator (ITM) or the US Federal Information Processing Standards (FIPS) code will only be shown when appropriate. `no_annotations` is `TRUE` by default, which means that the output will not contain annotations. (Yes, the inverted argument names are confusing. We just follow OpenCage's lead here.)

* `no_dedupe` is `FALSE` by default. When TRUE the output will not be deduplicated.

For more information about the output and the query parameters, see the package documentation, the [API doc](https://opencagedata.com/api) and [OpenCage FAQ](https://opencagedata.com/faq).

## Specifying the target area

The `bounds`, `countrycode` and `proximity` arguments can make the query more precise. They are only relevant and available for forward geocoding. 

* `bounds`: The `bounds` parameter restricts the possible results to a defined bounding box. A bounding box is a named numeric vector with four coordinates specifying its south-west and north-east corners: `(xmin, ymin, xmax, ymax)`. The bounds parameter can most easily be specified with the `oc_bbox()` helper, for example like `bounds = oc_bbox(-0.56, 51.28, 0.27, 51.68)`. OpenCage provides a '[bounds-finder](https://opencagedata.com/bounds-finder)' to interactively determine bounds values.

  Below is an example of the use of `bounds` where the rectangle given in the second call does not include Europe so that we don't get results for Berlin in Germany.

```{r bounds, message=FALSE}
results1 <- oc_forward(placename = "Berlin")
knitr::kable(results1)
results2 <- oc_forward(placename = "Berlin", bounds = oc_bbox(-90, 38, 0, 45))
knitr::kable(results2)
```

* `countrycode`: The `countrycode` parameter restricts the results to the given country. The country code is a two letter code as defined by the [ISO 3166-1 Alpha 2](https://www.iso.org/obp/ui/#search/code) standard. E.g. "GB" for the United Kingdom, "FR" for France, "US" for United States. Multiple countrycodes per `placename` must be wrapped in a list. See example below.

```{r countrycode, message=FALSE}
results3 <- oc_forward(placename = "Paris", countrycode = "US")
knitr::kable(results3)

results4 <- oc_forward(placename = "Paris", countrycode = list(c("CA", "US")))
knitr::kable(results4)

```

* `proximity`: The `proximity` parameter provides OpenCage with a hint to bias results in favour of those closer to the specified location. It is just one of many factors used for ranking results, however, and (some) results may be far away from the location or point passed to the `proximity` parameter. A point is a named numeric vector of a latitude, longitude coordinate pair in decimal format. The `proximity` parameter can most easily be specified with the `oc_points()` helper, for example like `proximity = oc_points(51.9526, 7.6324)`.

  Below we provide a point near Lexington, Kentucky, USA. Note that the French capital is ranked third, listed before other places in the US, which are closer to the point provided. This illustrates how `proximity` is only one of many factors influencing the ranking of results.

```{r proximity, message=FALSE}
results5 <- oc_forward(placename = "Paris", proximity = oc_points(38.0, -84.6))
knitr::kable(results5)

```

