---
title: "Forward geocoding: Converting addresses to coordinates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{forward-geocoding_addresses-to-coordinates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library("tidyverse")
```

`oc_forward()` takes one or many placenames and will use the OpenCage API to convert them to coordinates.

```{r}
library("opencage")
oc_results <- oc_forward(placename = c("Sarzeau", "221b Baker Street, London"))
oc_results
```

Use `unnest()` from `{tidyr}` to extract the OpenCage data from the `list` column:

```{r}
library("tidyverse")
oc_results <- oc_results %>%
  unnest(cols = data)
oc_results
```

The `oc_formatted` column contains the formatted address returned by OpenCage

```{r}
oc_results %>%
  pull(oc_formatted)
```

It is more than likely that `oc_forward()` will return more than one result per placename. This may be due to either a lack of precision in your place name or many places sharing similar names. Results are **not** ordered by confidence (or any metric of "correctness") but instead by their **relevance**. To improve the quality of your geocoding results see [OpenCage's best practices](https://opencagedata.com/api#bestpractices).

To augment an existing dataset with geocoded coordinates use `oc_forward_df()`:

```{r}
street_addresses <- tibble(
  street = c("High Street", "Main Street"),
  city = c("Reading", "Reading"),
  country = c("England", "United States")
)

oc_forward_df(street_addresses, placename = paste(street, city, country, sep = ", "), output = "all")
```

## Specifying the target area {#specify-area}

There are three arguments that can change the precision of results returned by both `oc_forward()` and `oc_forward_df()`; `countrycode`, `bounds` and `proximity`.

- `countrycode`: This restricts the results to a given country using the [ISO 3166-1 Alpha 2](https://www.iso.org/obp/ui/#search/code) country code standard. A complete set of these country codes is provided in the `country_codes` dataset.

```{r countrycode}
library("leaflet")
oc_results <- oc_forward(placename = c("Memphis", "Memphis"), countrycode = c("US", "EG"))

oc_results %>%
  unnest(cols = data) %>%
  leaflet() %>%
  addTiles() %>%
  addMarkers(lng = ~oc_lng,
             lat = ~oc_lat)
```

- `bounds`: The `bounds` parameter restricts the possible results to a defined bounding box. A bounding box is a named numeric vector with four coordinates specifying its south-west and north-east corners: `(xmin, ymin, xmax, ymax)`. The bounds parameter can most easily be specified with the `oc_bbox()` helper, for example like `bounds = oc_bbox(-0.56, 51.28, 0.27, 51.68)`. OpenCage provides a '[bounds-finder](https://opencagedata.com/bounds-finder)' to interactively determine bounds values.

```{r bounds, message=FALSE}
oc_results <- oc_forward(placename = "Berlin", bounds = oc_bbox(-90, 38, 0, 45))

oc_results %>%
  unnest(cols = data) %>%
  leaflet() %>%
  addTiles() %>%
  addMarkers(lng = ~oc_lng,
             lat = ~oc_lat)
```

- `proximity`: The `proximity` parameter provides OpenCage with a hint to bias results in favour of those closer to the specified location. It is just one of many factors used for ranking results, however, and (some) results may be far away from the location or point passed to the `proximity` parameter. A point is a named numeric vector of a latitude, longitude coordinate pair in decimal format. The `proximity` parameter can most easily be specified with the `oc_points()` helper, for example like `proximity = oc_points(51.9526, 7.6324)`. Below we provide a point near Lexington, Kentucky, USA. Note that while 7 results are found in the USA, the Paris of France is still included due to the high relevance of that result.

```{r proximity, message=FALSE}
oc_results <- oc_forward(placename = "Paris", proximity = oc_points(38.0, -84.6))

oc_results %>%
  unnest(cols = data) %>%
  leaflet() %>%
  addTiles() %>%
  addMarkers(lng = ~oc_lng,
             lat = ~oc_lat)
```

## Specifying what is returned

* `language`: If you would like to get your results in a specific language, you can pass an [IETF BCP 47 language tag](https://en.wikipedia.org/wiki/IETF_language_tag), such as "es" for Spanish or "pt-BR" for Brazilian Portuguese, to the `language` parameter. OpenCage will attempt to return results in that language. Alternatively you can specify the "native" tag, in which case OpenCage will attempt to return the response in the "official" language(s). For further details see [OpenCage's API documentation](https://opencagedata.com/api#language) on that subject. In case the `language` parameter is set to `NULL` (which is the default), the tag is not recognized, or OpenCage does not have a record in that language, the results will be returned in English. 

  To find the correct language tag for your desired language, you can search for the language on the [BCP47 language subtag lookup](https://r12a.github.io/app-subtags/) for example. Note however, that there are some language tags in use on e.g. OpenStreetMap, one of OpenCage's main sources, that do not conform with the IETF BCP 47 standard. For example OSM uses [`zh_pinyin`](https://wiki.openstreetmap.org/w/index.php?title=Multilingual_names#China) instead of `zh-Latn-pinyin` for [Hanyu Pinyin](https://en.wikipedia.org/wiki/Pinyin). It might therefore be helpful to consult the details page of e.g. the target country on openstreetmap.org in order to see which language tags are actually used. In any case, neither OpenCage nor the functions in this package will validate the language tags you provide.

```{r language, message=FALSE}
results6 <- oc_forward(placename = "Berlin", country = "DE", language = "de")
knitr::kable(results6)

```

* `limit` specifies the maximum number of results that should be returned. Integer values between 1 and 100 are allowed, the default is 10 for `oc_forward()` and 1 for `oc_forward_df()`. Reverse geocoding always returns at most one result. 

* `min_confidence`, an integer value between 0 and 10, indicates the precision of the returned result as defined by its geographical extent, (i.e. by the extent of the result's bounding box). See the \href{API documentation}{https://opencagedata.com/api#confidence} for details. Only results with at least the requested confidence will be returned.

* `no_annotations`: OpenCage supplies additional information about the result location in the [annotations](https://opencagedata.com/api#annotations). They include, among others, country information, time of sunset and sunrise, or the location in different geocoding formats, like Maidenhead, Mercator projection (EPSG 3857), geohash or what3words. Some annotations, like the Irish Transverse Mercator (ITM) or the US Federal Information Processing Standards (FIPS) code will only be shown when appropriate. `no_annotations` is `TRUE` by default, which means that the output will not contain annotations. (Yes, the inverted argument names are confusing. We just follow OpenCage's lead here.)

* `no_dedupe` is `FALSE` by default. When TRUE the output will not be deduplicated.

For more information about the output and the query parameters, see the package documentation, the [API doc](https://opencagedata.com/api) and [OpenCage FAQ](https://opencagedata.com/faq).

